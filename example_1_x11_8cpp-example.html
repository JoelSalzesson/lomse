<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lomse library. API documentation: example_1_x11.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.26.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('example_1_x11_8cpp-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">example_1_x11.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Code for Linux with X11. Example 1: How to display a music score.</p>
<div class="fragment"><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// This is free and unencumbered software released into the public domain.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Anyone is free to copy, modify, publish, use, compile, sell, or</span></div><div class="line"><span class="comment">// distribute this software, either in source code form or as a compiled</span></div><div class="line"><span class="comment">// binary, for any purpose, commercial or non-commercial, and by any</span></div><div class="line"><span class="comment">// means.</span></div><div class="line"><span class="comment">// </span></div><div class="line"><span class="comment">// In jurisdictions that recognize copyright laws, the author or authors</span></div><div class="line"><span class="comment">// of this software dedicate any and all copyright interest in the</span></div><div class="line"><span class="comment">// software to the public domain. We make this dedication for the benefit</span></div><div class="line"><span class="comment">// of the public at large and to the detriment of our heirs and</span></div><div class="line"><span class="comment">// successors. We intend this dedication to be an overt act of</span></div><div class="line"><span class="comment">// relinquishment in perpetuity of all present and future rights to this</span></div><div class="line"><span class="comment">// software under copyright law.</span></div><div class="line"><span class="comment">// </span></div><div class="line"><span class="comment">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span></div><div class="line"><span class="comment">// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span></div><div class="line"><span class="comment">// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span></div><div class="line"><span class="comment">// IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span></div><div class="line"><span class="comment">// OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span></div><div class="line"><span class="comment">// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span></div><div class="line"><span class="comment">// OTHER DEALINGS IN THE SOFTWARE.</span></div><div class="line"><span class="comment">// </span></div><div class="line"><span class="comment">// For more information, please refer to &lt;http:unlicense.org&gt;</span></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"></div><div class="line"><span class="comment">// header files required for X11. The order is important:</span></div><div class="line"><span class="preprocessor">#include &lt;X11/Xlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;X11/Xutil.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;X11/Xos.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//some additional needed stuff</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//lomse headers</span></div><div class="line"><span class="preprocessor">#include &lt;lomse_doorway.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;lomse_document.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;lomse_graphic_view.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;lomse_interactor.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;lomse_presenter.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;lomse_events.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span>lomse;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// In this first example we are just going to display an score on the main window.</span></div><div class="line"><span class="comment">// Let&#39;s define the necessary variables:</span></div><div class="line"><span class="comment">//</span></div><div class="line"><a name="_a0"></a><a class="code" href="classLomseDoorway.html">LomseDoorway</a>    m_lomse;        <span class="comment">//the Lomse library doorway</span></div><div class="line"><a name="_a1"></a><a class="code" href="classPresenter.html">Presenter</a>*      m_pPresenter;   <span class="comment">//relates the View, the Document and the Interactor</span></div><div class="line"></div><div class="line"><span class="comment">//the Lomse View renders its content on a bitmap. To manage it, Lomse</span></div><div class="line"><span class="comment">//associates the bitmap to a RenderingBuffer object.</span></div><div class="line"><span class="comment">//It is your responsibility to render the bitmap on a window.</span></div><div class="line"><span class="comment">//Here you define the rendering buffer and its associated bitmap to be</span></div><div class="line"><span class="comment">//used by the previously defined View.</span></div><div class="line">RenderingBuffer     m_rbuf_window;      <span class="comment">//Lomse struct to contain the bitmap</span></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*      m_buf_window;       <span class="comment">//memory for the bitmap</span></div><div class="line"><span class="comment">//some X11 related variables</span></div><div class="line">XImage*             m_ximg_window;      <span class="comment">//the image to display</span></div><div class="line"><span class="keywordtype">int</span>                 m_depth;            <span class="comment">//color depth</span></div><div class="line">Visual*             m_visual;           <span class="comment">//X11 Visual to use</span></div><div class="line"></div><div class="line"><span class="comment">//Lomse can manage a lot of bitmap formats and pixel formats. You must</span></div><div class="line"><span class="comment">//define the format that you are going to use</span></div><div class="line"><span class="keywordtype">int</span>              m_byte_order;  <span class="comment">//endian (platform byte ordering)</span></div><div class="line"><a class="code" href="group__enumerations.html#gafb559e26bc610db43ba605230a142898">EPixelFormat</a>     m_format;      <span class="comment">//bitmap format</span></div><div class="line"><span class="keywordtype">unsigned</span>         m_bpp;         <span class="comment">//bits per pixel</span></div><div class="line"><span class="keywordtype">bool</span>             m_flip_y;      <span class="comment">//true if y axis is reversed</span></div><div class="line"></div><div class="line"><span class="comment">//All typical X stuff needed to run the program and the main events handler loop,</span></div><div class="line"><span class="comment">//as well as for handling windows:</span></div><div class="line">Display*    m_pDisplay;     <span class="comment">//points to the X Server.</span></div><div class="line"><span class="keywordtype">int</span>         m_screen;       <span class="comment">//refers to which screen of the display to use.</span></div><div class="line">Window      m_window;       <span class="comment">//the actual window itself</span></div><div class="line">GC          m_gc;           <span class="comment">//And the GC is the graphics context.</span></div><div class="line">Atom        m_close_atom;</div><div class="line">XSetWindowAttributes m_window_attributes;</div><div class="line"></div><div class="line"><span class="comment">//some additinal variables</span></div><div class="line"><span class="keywordtype">bool</span>    m_view_needs_redraw;      <span class="comment">//to control when the View must be re-drawn</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> display_view_content(<span class="keyword">const</span> rendering_buffer* rbuf)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span>(m_ximg_window == 0) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">//copy the view bitmap onto the image</span></div><div class="line">    m_ximg_window-&gt;data = (<span class="keywordtype">char</span>*)m_buf_window;</div><div class="line"></div><div class="line">    <span class="comment">//display the image</span></div><div class="line">    XPutImage(m_pDisplay,</div><div class="line">              m_window,</div><div class="line">              m_gc,</div><div class="line">              m_ximg_window,</div><div class="line">              0, 0, 0, 0,</div><div class="line">              rbuf-&gt;width(),</div><div class="line">              rbuf-&gt;height()</div><div class="line">             );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> do_update_window()</div><div class="line">{</div><div class="line">    <span class="comment">// Invoking do_update_window() results in just putting immediately the content</span></div><div class="line">    <span class="comment">// of the currently rendered buffer to the window without neither calling</span></div><div class="line">    <span class="comment">// any lomse methods nor generating platform related events (i.e. window on_paint)</span></div><div class="line"></div><div class="line">    display_view_content(&amp;m_rbuf_window);</div><div class="line">    XSync(m_pDisplay, <span class="keyword">false</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> update_window(<a class="code" href="group__typedefs.html#ga4150a238b3c170bd2466bab5355fafca">SpEventInfo</a> pEvent)</div><div class="line">{</div><div class="line">    <span class="comment">// Callback method for Lomse</span></div><div class="line"></div><div class="line">    do_update_window();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> open_document()</div><div class="line">{</div><div class="line">    <span class="comment">//Normally you will load the content of a file. But in this</span></div><div class="line">    <span class="comment">//simple example we will create an empty document and define its content</span></div><div class="line">    <span class="comment">//from a text string</span></div><div class="line"></div><div class="line">    <span class="comment">//create a document and get the &#39;presenter&#39;.</span></div><div class="line">    <span class="comment">//The Presenter takes care of creating and maintaining all objects</span></div><div class="line">    <span class="comment">//and relationships between the document, its views and the interactors</span></div><div class="line">    <span class="comment">//to interact with the view</span></div><div class="line">    <span class="keyword">delete</span> m_pPresenter;</div><div class="line">    m_pPresenter = m_lomse.<a name="a2"></a><a class="code" href="classLomseDoorway.html#a1b00546f591c2041df5ed86ea0681948">new_document</a>(k_view_vertical_book,</div><div class="line">        <span class="stringliteral">&quot;(lenmusdoc (vers 0.0)&quot;</span></div><div class="line">            <span class="stringliteral">&quot;(content &quot;</span></div><div class="line">                <span class="stringliteral">&quot;(para (txt \&quot;Hello world!\&quot;))&quot;</span></div><div class="line">                <span class="stringliteral">&quot;(score (vers 1.6) &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;(instrument (musicData (clef G)(key C)(time 2 4)(n c4 q) )))&quot;</span></div><div class="line">            <span class="stringliteral">&quot;)&quot;</span></div><div class="line">        <span class="stringliteral">&quot;)&quot;</span>,</div><div class="line">        <a name="a3"></a><a class="code" href="classDocument.html#a0af272723339cb2f42e33aeadeb55b24a228b51dcf229a1423f0f1734b422846e">Document::k_format_ldp</a>);</div><div class="line"></div><div class="line">    <span class="comment">//get the pointer to the interactor, set the rendering buffer and register for</span></div><div class="line">    <span class="comment">//receiving desired events</span></div><div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;<a name="a4"></a><a class="code" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">get_interactor</a>(0).lock())</div><div class="line">    {</div><div class="line">        <span class="comment">//connect the View with the window buffer</span></div><div class="line">        spInteractor-&gt;set_rendering_buffer(&amp;m_rbuf_window);</div><div class="line"></div><div class="line">        <span class="comment">//ask to receive desired events</span></div><div class="line">        spInteractor-&gt;add_event_handler(<a name="a5"></a><a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656daf6c7408c96763e94fd2df7d6235f7a49">k_update_window_event</a>, update_window);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> update_view_content()</div><div class="line">{</div><div class="line">    <span class="comment">//request the view to re-draw the bitmap</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!m_pPresenter) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;<a class="code" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">get_interactor</a>(0).lock())</div><div class="line">        spInteractor-&gt;redraw_bitmap();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">bool</span> determine_suitable_bitmap_format()</div><div class="line">{</div><div class="line">    <span class="comment">//Returns false if we can not find a suitable bitmap format</span></div><div class="line">    <span class="comment">//for this platform</span></div><div class="line"></div><div class="line">    <span class="comment">//determine color depth</span></div><div class="line">    m_depth  = XDefaultDepth(m_pDisplay, m_screen);</div><div class="line">    m_visual = XDefaultVisual(m_pDisplay, m_screen);</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> r_mask = m_visual-&gt;red_mask;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> g_mask = m_visual-&gt;green_mask;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> b_mask = m_visual-&gt;blue_mask;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(m_depth &lt; 15 || r_mask == 0 || g_mask == 0 || b_mask == 0)</div><div class="line">    {</div><div class="line">        fprintf(stderr,</div><div class="line">               <span class="stringliteral">&quot;There&#39;s no Visual compatible with minimal Lomse requirements:\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;At least 15-bit color depth and TrueColor or DirectColor class.\n\n&quot;</span>);</div><div class="line">        XCloseDisplay(m_pDisplay);</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//determine byte ordering</span></div><div class="line">    <span class="keywordtype">int</span> t = 1;</div><div class="line">    <span class="keywordtype">int</span> hw_byte_order = LSBFirst;</div><div class="line">    <span class="keywordflow">if</span>(*(<span class="keywordtype">char</span>*)&amp;t == 0)</div><div class="line">        hw_byte_order = MSBFirst;</div><div class="line"></div><div class="line">    <span class="comment">//use mask to determine the bitmap format to use</span></div><div class="line">    <span class="keywordflow">switch</span>(m_depth)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> 15:</div><div class="line">            m_bpp = 16;</div><div class="line">            <span class="keywordflow">if</span>(r_mask == 0x7C00 &amp;&amp; g_mask == 0x3E0 &amp;&amp; b_mask == 0x1F)</div><div class="line">            {</div><div class="line">                m_format = <a name="a6"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a6bc9dbd1200a63f27353713c63a3521d">k_pix_format_rgb555</a>;</div><div class="line">                m_byte_order = hw_byte_order;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> 16:</div><div class="line">            m_bpp = 16;</div><div class="line">            <span class="keywordflow">if</span>(r_mask == 0xF800 &amp;&amp; g_mask == 0x7E0 &amp;&amp; b_mask == 0x1F)</div><div class="line">            {</div><div class="line">                m_format = <a name="a7"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a687d9509c5c062fed60cbeae22465e39">k_pix_format_rgb565</a>;</div><div class="line">                m_byte_order = hw_byte_order;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> 24:</div><div class="line">        <span class="keywordflow">case</span> 32:</div><div class="line">            m_bpp = 32;</div><div class="line">            <span class="keywordflow">if</span>(g_mask == 0xFF00)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span>(r_mask == 0xFF &amp;&amp; b_mask == 0xFF0000)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">switch</span>(m_format)</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">case</span> <a name="a8"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898ad6396874d1012fad53ebaff1393c8df8">k_pix_format_rgba32</a>:</div><div class="line">                            m_format = <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898ad6396874d1012fad53ebaff1393c8df8">k_pix_format_rgba32</a>;</div><div class="line">                            m_byte_order = LSBFirst;</div><div class="line">                            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> <a name="a9"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a8ca200479e272d6e4841cd01d9cbe657">k_pix_format_abgr32</a>:</div><div class="line">                            m_format = <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a8ca200479e272d6e4841cd01d9cbe657">k_pix_format_abgr32</a>;</div><div class="line">                            m_byte_order = MSBFirst;</div><div class="line">                            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                            m_byte_order = hw_byte_order;</div><div class="line">                            m_format =</div><div class="line">                                (hw_byte_order == LSBFirst) ?</div><div class="line">                                <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898ad6396874d1012fad53ebaff1393c8df8">k_pix_format_rgba32</a> :</div><div class="line">                                <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a8ca200479e272d6e4841cd01d9cbe657">k_pix_format_abgr32</a>;</div><div class="line">                            <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span>(r_mask == 0xFF0000 &amp;&amp; b_mask == 0xFF)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">switch</span>(m_format)</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">case</span> <a name="a10"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a115170a7630e87bdb0d90728b79c1e4e">k_pix_format_argb32</a>:</div><div class="line">                            m_format = <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a115170a7630e87bdb0d90728b79c1e4e">k_pix_format_argb32</a>;</div><div class="line">                            m_byte_order = MSBFirst;</div><div class="line">                            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> <a name="a11"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898acbfd950e1ef577e4a697ad2dadd30ec7">k_pix_format_bgra32</a>:</div><div class="line">                            m_format = <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898acbfd950e1ef577e4a697ad2dadd30ec7">k_pix_format_bgra32</a>;</div><div class="line">                            m_byte_order = LSBFirst;</div><div class="line">                            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                            m_byte_order = hw_byte_order;</div><div class="line">                            m_format =</div><div class="line">                                (hw_byte_order == MSBFirst) ?</div><div class="line">                                <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a115170a7630e87bdb0d90728b79c1e4e">k_pix_format_argb32</a> :</div><div class="line">                                <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898acbfd950e1ef577e4a697ad2dadd30ec7">k_pix_format_bgra32</a>;</div><div class="line">                            <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//if no suitable format found, terminate</span></div><div class="line">    <span class="keywordflow">if</span>(m_format == <a name="a12"></a><a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898a0a8e233d72c2d66ca39207b151d7e18f">k_pix_format_undefined</a>)</div><div class="line">    {</div><div class="line">        fprintf(stderr,</div><div class="line">               <span class="stringliteral">&quot;RGB masks are not compatible with Lomse pixel formats:\n&quot;</span></div><div class="line">               <span class="stringliteral">&quot;R=%08lx, R=%08lx, B=%08lx\n&quot;</span>, r_mask, g_mask, b_mask);</div><div class="line">        XCloseDisplay(m_pDisplay);</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">bool</span> create_rendering_buffer(<span class="keywordtype">unsigned</span> width, <span class="keywordtype">unsigned</span> height, <span class="keywordtype">unsigned</span> flags)</div><div class="line">{</div><div class="line">    <span class="comment">//allocate memory for the bitmap, fill it with 1&#39;s</span></div><div class="line">    m_buf_window = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[width * height * (m_bpp / 8)];</div><div class="line">    memset(m_buf_window, 255, width * height * (m_bpp / 8));</div><div class="line"></div><div class="line">    <span class="comment">//attach this memory to the rendering buffer</span></div><div class="line">    m_rbuf_window.attach(m_buf_window, width, height,</div><div class="line">                         (m_flip_y ? -width * (m_bpp / 8) : width * (m_bpp / 8)) );</div><div class="line"></div><div class="line">    <span class="comment">//create an X11 image using the allocated memory as buffer</span></div><div class="line">    m_ximg_window = XCreateImage(m_pDisplay,</div><div class="line">                                 m_visual,</div><div class="line">                                 m_depth,</div><div class="line">                                 ZPixmap,</div><div class="line">                                 0,</div><div class="line">                                 (<span class="keywordtype">char</span>*)m_buf_window,</div><div class="line">                                 width,</div><div class="line">                                 height,</div><div class="line">                                 m_bpp,</div><div class="line">                                 width * (m_bpp / 8)</div><div class="line">                                );</div><div class="line">    m_ximg_window-&gt;byte_order = m_byte_order;</div><div class="line"></div><div class="line">    <span class="comment">//raise flag to redraw window when requested</span></div><div class="line">    m_view_needs_redraw = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> delete_rendering_buffer()</div><div class="line">{</div><div class="line">    <span class="keyword">delete</span> [] m_buf_window;</div><div class="line">    <span class="keywordflow">if</span> (m_ximg_window)</div><div class="line">    {</div><div class="line">        m_ximg_window-&gt;data = 0;</div><div class="line">        XDestroyImage(m_ximg_window);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// application main events handler loop</span></div><div class="line"><span class="keywordtype">int</span> handle_events()</div><div class="line">{</div><div class="line">    XFlush(m_pDisplay);</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> quit = <span class="keyword">false</span>;</div><div class="line">    <span class="keywordflow">while</span>(!quit)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(m_view_needs_redraw)</div><div class="line">        {</div><div class="line">            update_view_content();</div><div class="line">            do_update_window();</div><div class="line">            m_view_needs_redraw = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        XEvent event;</div><div class="line">        XNextEvent(m_pDisplay, &amp;event);</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(event.type)</div><div class="line">        {</div><div class="line">            <span class="comment">//--------------------------------------------------------------------</span></div><div class="line">            <span class="keywordflow">case</span> ConfigureNotify:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span>(event.xconfigure.width  != <span class="keywordtype">int</span>(m_rbuf_window.width()) ||</div><div class="line">                   event.xconfigure.height != <span class="keywordtype">int</span>(m_rbuf_window.height()))</div><div class="line">                {</div><div class="line">                    <span class="keywordtype">int</span> width  = <span class="keyword">event</span>.xconfigure.width;</div><div class="line">                    <span class="keywordtype">int</span> height = <span class="keyword">event</span>.xconfigure.height;</div><div class="line">                    delete_rendering_buffer();</div><div class="line">                    create_rendering_buffer(width, height, 0);</div><div class="line">                    do_update_window();</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">//--------------------------------------------------------------------</span></div><div class="line">            <span class="keywordflow">case</span> Expose:</div><div class="line">                <span class="keywordflow">if</span> (event.xexpose.count == 0)</div><div class="line">                {</div><div class="line">                    display_view_content(&amp;m_rbuf_window);</div><div class="line">                    XFlush(m_pDisplay);</div><div class="line">                    XSync(m_pDisplay, <span class="keyword">false</span>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">//--------------------------------------------------------------------</span></div><div class="line">            <span class="keywordflow">case</span> ClientMessage:</div><div class="line">                <span class="keywordflow">if</span>(event.xclient.format == 32</div><div class="line">                   &amp;&amp; event.xclient.data.l[0] == <span class="keywordtype">int</span>(m_close_atom) )</div><div class="line">                {</div><div class="line">                    quit = <span class="keyword">true</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> define_events_to_process()</div><div class="line">{</div><div class="line">    XSelectInput(m_pDisplay, m_window, ExposureMask | StructureNotifyMask );</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> create_main_window(<span class="keywordtype">unsigned</span> width, <span class="keywordtype">unsigned</span> height)</div><div class="line">{</div><div class="line">    memset(&amp;m_window_attributes, 0, <span class="keyword">sizeof</span>(m_window_attributes));</div><div class="line">    m_window_attributes.border_pixel = XBlackPixel(m_pDisplay, m_screen);</div><div class="line">    m_window_attributes.background_pixel = XWhitePixel(m_pDisplay, m_screen);</div><div class="line">    m_window_attributes.override_redirect = 0;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> window_mask = CWBackPixel | CWBorderPixel;</div><div class="line"></div><div class="line">    m_window = XCreateWindow(m_pDisplay,</div><div class="line">                             XDefaultRootWindow(m_pDisplay),</div><div class="line">                             0, 0,</div><div class="line">                             width, height,</div><div class="line">                             0,</div><div class="line">                             m_depth,</div><div class="line">                             InputOutput,</div><div class="line">                             CopyFromParent,</div><div class="line">                             window_mask,</div><div class="line">                             &amp;m_window_attributes</div><div class="line">                            );</div><div class="line"></div><div class="line">    <span class="comment">//set window title</span></div><div class="line">    XSetStandardProperties(m_pDisplay,</div><div class="line">                           m_window,</div><div class="line">                           <span class="stringliteral">&quot;Lomse examples. Example_1&quot;</span>,     <span class="comment">//window title</span></div><div class="line">                           <span class="stringliteral">&quot;Lomse_1&quot;</span>,                       <span class="comment">//name in tasks bar</span></div><div class="line">                           None,</div><div class="line">                           NULL,</div><div class="line">                           0,</div><div class="line">                           NULL</div><div class="line">                          );</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// create the Graphics Context</span></div><div class="line">    m_gc = XCreateGC(m_pDisplay, m_window, 0, 0);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">bool</span> init_x()</div><div class="line">{</div><div class="line">    <span class="comment">//returns false if an error occurs</span></div><div class="line"></div><div class="line">    <span class="comment">//create X connection</span></div><div class="line">    m_pDisplay = XOpenDisplay(NULL);</div><div class="line">    <span class="keywordflow">if</span>(m_pDisplay == 0)</div><div class="line">    {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Unable to open DISPLAY!\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    m_screen = XDefaultScreen(m_pDisplay);</div><div class="line"></div><div class="line">    <span class="comment">//As lomse renders on a bitmap it is necessary to determine the best</span></div><div class="line">    <span class="comment">//bitmap format suited for your specific OS and platform</span></div><div class="line">    <span class="keywordflow">if</span> (!determine_suitable_bitmap_format())</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    create_main_window(850, 600);       <span class="comment">//850 x 600 pixels</span></div><div class="line">    create_rendering_buffer(850, 600, 0);</div><div class="line"></div><div class="line">    XMapWindow(m_pDisplay, m_window);</div><div class="line"></div><div class="line">    m_close_atom = XInternAtom(m_pDisplay, <span class="stringliteral">&quot;WM_DELETE_WINDOW&quot;</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    XSetWMProtocols(m_pDisplay, m_window, &amp;m_close_atom, 1);</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;        <span class="comment">//no error</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> close_x()</div><div class="line">{</div><div class="line">    XFreeGC(m_pDisplay, m_gc);</div><div class="line">    XDestroyWindow(m_pDisplay,m_window);</div><div class="line">    XCloseDisplay(m_pDisplay);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="keywordtype">void</span> initialize_lomse()</div><div class="line">{</div><div class="line">    <span class="comment">//initialize the Lomse library</span></div><div class="line">    m_flip_y = <span class="keyword">false</span>;               <span class="comment">//y axis is not reversed</span></div><div class="line">    m_lomse.<a name="a13"></a><a class="code" href="classLomseDoorway.html#a01e4f12682054e5a96afa236501ac80f">init_library</a>(m_format, 96, m_flip_y);   <span class="comment">//resolution=96 ppi</span></div><div class="line"></div><div class="line">    <span class="comment">//initialize lomse related variables</span></div><div class="line">    m_pPresenter = NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//---------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">// application entry point</span></div><div class="line"><span class="keywordtype">int</span> main ()</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (!init_x())</div><div class="line">        exit(1);</div><div class="line"></div><div class="line">    initialize_lomse();</div><div class="line"></div><div class="line">    <span class="comment">//create a music score and a View. The view will display the score</span></div><div class="line">    <span class="comment">//when the paint event is sent to lomse, once the main windows is</span></div><div class="line">    <span class="comment">//shown and the event handling loop is started</span></div><div class="line">    open_document();</div><div class="line"></div><div class="line">    <span class="comment">//run the main events handling loop</span></div><div class="line">    define_events_to_process();</div><div class="line">    handle_events();</div><div class="line"></div><div class="line">    <span class="comment">//delete the view and the rendering buffer</span></div><div class="line">    delete_rendering_buffer();</div><div class="line">    <span class="keyword">delete</span> m_pPresenter;    <span class="comment">//this will also delete the Doc, the Views and all other stuff</span></div><div class="line"></div><div class="line">    <span class="comment">//close X connection</span></div><div class="line">    close_x();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Dec 29 2018 16:44:30 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
